<!DOCTYPE html>
<html>
<head>
    <title>Gandalf System Health</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .health-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

            .health-card.healthy {
                border-top: 4px solid #10b981;
            }

            .health-card.warning {
                border-top: 4px solid #f59e0b;
            }

            .health-card.error {
                border-top: 4px solid #ef4444;
            }

        .status-icon {
            font-size: 48px;
            margin: 10px 0;
        }

        .metric {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧙‍♂️ Gandalf System Health <button class="refresh-btn" onclick="checkAllHealth()">Refresh</button></h1>
        <div class="health-grid" id="health-grid">
            <div class="health-card" id="collector-status"><h3>Data Collector</h3><div class="status-icon">⏳</div><div class="metric">Checking...</div></div>
            <div class="health-card" id="analyzer-status"><h3>Pattern Analyzer</h3><div class="status-icon">⏳</div><div class="metric">Checking...</div></div>
            <div class="health-card" id="monitor-status"><h3>System Monitor</h3><div class="status-icon">⏳</div><div class="metric">Checking...</div></div>
            <div class="health-card" id="database-status"><h3>Database</h3><div class="status-icon">⏳</div><div class="metric">Checking...</div></div>
        </div>
        <h2>System Metrics</h2>
        <div class="health-grid" id="metrics-grid">
            <div class="health-card"><h3>Data Points (Total)</h3><div class="metric" id="data-points">-</div></div>
            <div class="health-card"><h3>Patterns Found (Total)</h3><div class="metric" id="patterns-found">-</div></div>
            <div class="health-card"><h3>Active Signals (Cache)</h3><div class="metric" id="active-signals">-</div></div>
            <div class="health-card"><h3>Last Collection</h3><div class="metric" id="last-collection">-</div></div>
        </div>
    </div>
    <script>
        const API_BASE_URL = '/api';

        async function checkWorkerHealth(serviceName, externalUrl) {
            const card = document.getElementById(`${serviceName}-status`);
            try {
                const response = await fetch(externalUrl);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();

                card.className = 'health-card healthy';
                card.querySelector('.status-icon').textContent = '✅';
                card.querySelector('.metric').textContent = 'Operational';

                if (serviceName === 'collector' && data.last_collection_age_minutes != null) {
                    document.getElementById('last-collection').textContent = `${data.last_collection_age_minutes} min ago`;
                }
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Offline';
                console.error(`Health check failed for ${serviceName}:`, error);
            }
        }

        async function checkDatabaseHealth() {
            const card = document.getElementById('database-status');
            try {
                const response = await fetch(`${API_BASE_URL}/market_data?select=timestamp&limit=1`);
                if (!response.ok) throw new Error('Database response not OK');
                card.className = 'health-card healthy';
                card.querySelector('.status-icon').textContent = '✅';
                card.querySelector('.metric').textContent = 'Connected';
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Connection Failed';
            }
        }

        async function loadMetrics() {
            try {
                // To get the total count, we make a HEAD request and read the Content-Range header
                const dpResponse = await fetch(`${API_BASE_URL}/market_data?select=count`, { method: 'HEAD' });
                const dpRange = dpResponse.headers.get('content-range');
                document.getElementById('data-points').textContent = dpRange ? dpRange.split('/')[1] : 'N/A';

                const pResponse = await fetch(`${API_BASE_URL}/discovered_patterns?select=count`, { method: 'HEAD' });
                const pRange = pResponse.headers.get('content-range');
                document.getElementById('patterns-found').textContent = pRange ? pRange.split('/')[1] : '0';

                const sigResponse = await fetch(`${API_BASE_URL}/signals`);
                const signals = await sigResponse.json();
                document.getElementById('active-signals').textContent = signals.length;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function checkAllHealth() {
            await Promise.all([
                checkWorkerHealth('collector', 'https://gandalf-collector.psnedujime.workers.dev/health'),
                checkWorkerHealth('analyzer', 'https://gandalf-analyzer.psnedujime.workers.dev'),
                checkWorkerHealth('monitor', 'https://gandalf-monitor.psnedujime.workers.dev'),
                checkDatabaseHealth(),
                loadMetrics()
            ]);
        }

        // Check on load and then every minute
        checkAllHealth();
        setInterval(checkAllHealth, 60000); // FIXED THE TYPO HERE
    </script>
</body>
</html>