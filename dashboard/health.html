<!DOCTYPE html>
<html>
<head>
    <title>Gandalf System Health</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .health-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

            .health-card.healthy {
                border-top: 4px solid #10b981;
            }

            .health-card.warning {
                border-top: 4px solid #f59e0b;
            }

            .health-card.error {
                border-top: 4px solid #ef4444;
            }

        .status-icon {
            font-size: 48px;
            margin: 10px 0;
        }

        .metric {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .logs {
            background: #0f172a;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: scroll;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            🧙‍♂️ Gandalf System Health
            <button class="refresh-btn" onclick="checkAllHealth()">Refresh</button>
        </h1>

        <div class="health-grid" id="health-grid">
            <div class="health-card" id="collector-status">
                <h3>Data Collector</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>

            <div class="health-card" id="analyzer-status">
                <h3>Pattern Analyzer</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>

            <div class="health-card" id="monitor-status">
                <h3>System Monitor</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>

            <div class="health-card" id="database-status">
                <h3>Database</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>
        </div>

        <h2>System Metrics</h2>
        <div class="health-grid" id="metrics-grid">
            <div class="health-card">
                <h3>Data Points (24h)</h3>
                <div class="metric" id="data-points">-</div>
            </div>

            <div class="health-card">
                <h3>Patterns Found</h3>
                <div class="metric" id="patterns-found">-</div>
            </div>

            <div class="health-card">
                <h3>Active Signals</h3>
                <div class="metric" id="active-signals">-</div>
            </div>

            <div class="health-card">
                <h3>Storage Used</h3>
                <div class="metric" id="storage-used">-</div>
            </div>
        </div>

        <h2>Recent Logs</h2>
        <div class="logs" id="logs">
            <div>Loading logs...</div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const SUPABASE_URL = CONFIG.SUPABASE_URL;
        const SUPABASE_KEY = CONFIG.SUPABASE_KEY;

        async function checkHealth(service, url) {
            const card = document.getElementById(`${service}-status`);

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && (data.status === 'healthy' || data.healthy)) {
                    card.className = 'health-card healthy';
                    card.querySelector('.status-icon').textContent = '✅';
                    card.querySelector('.metric').textContent = 'Operational';
                } else {
                    card.className = 'health-card warning';
                    card.querySelector('.status-icon').textContent = '⚠️';
                    card.querySelector('.metric').textContent = data.issue || 'Issues detected';
                }
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Offline';
            }
        }

        async function checkDatabaseHealth() {
            const card = document.getElementById('database-status');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/market_data?select=count&limit=1`,
                    { headers: { 'apikey': SUPABASE_KEY } }
                );

                if (response.ok) {
                    card.className = 'health-card healthy';
                    card.querySelector('.status-icon').textContent = '✅';
                    card.querySelector('.metric').textContent = 'Connected';
                } else {
                    throw new Error('Database error');
                }
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Connection failed';
            }
        }

        async function loadMetrics() {
            // Data points in last 24h
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/market_data?select=count`,
                    { headers: { 'apikey': SUPABASE_KEY } }
                );

                const count = await response.text();
                document.getElementById('data-points').textContent =
                    parseInt(count) || '-';
            } catch (error) {
                console.error('Error loading data points:', error);
            }

            // Patterns found
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/discovered_patterns?select=count`,
                    { headers: { 'apikey': SUPABASE_KEY } }
                );

                const count = await response.text();
                document.getElementById('patterns-found').textContent =
                    parseInt(count) || '-';
            } catch (error) {
                console.error('Error loading patterns:', error);
            }

            // Active signals
            try {
                const response = await fetch(
                    'https://gandalf-analyzer.psnedujime.workers.dev/api/signals'
                );
                const signals = await response.json();
                document.getElementById('active-signals').textContent = signals.length;
            } catch (error) {
                console.error('Error loading signals:', error);
            }
        }

        async function loadLogs() {
            const logsDiv = document.getElementById('logs');

            // Simulate logs for now
            const logs = [
                `[${new Date().toISOString()}] System health check completed`,
                `[${new Date().toISOString()}] Data collection cycle finished`,
                `[${new Date().toISOString()}] Pattern analysis completed`,
                `[${new Date().toISOString()}] All systems operational`
            ];

            logsDiv.innerHTML = logs.map(log => `<div>${log}</div>`).join('');
        }

        async function checkAllHealth() {
            // Check each service
            await checkHealth('collector', 'https://gandalf-collector.psnedujime.workers.dev/health');
            await checkHealth('analyzer', 'https://gandalf-analyzer.psnedujime.workers.dev');
            await checkHealth('monitor', 'https://gandalf-monitor.psnedujime.workers.dev');
            await checkDatabaseHealth();

            // Load metrics
            await loadMetrics();
            await loadLogs();
        }

        // Check on load and every 30 seconds
        checkAllHealth();
        setInterval(checkAllHealth, 30000);
    </script>
</body>
</html>