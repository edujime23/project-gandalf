<!DOCTYPE html>
<html>
<head>
    <title>Gandalf System Health</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #0f172a;
            color: #e2e8f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .health-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

            .health-card.healthy {
                border-top: 4px solid #10b981;
            }

            .health-card.warning {
                border-top: 4px solid #f59e0b;
            }

            .health-card.error {
                border-top: 4px solid #ef4444;
            }

        .status-icon {
            font-size: 48px;
            margin: 10px 0;
        }

        .metric {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .logs {
            background: #0a0a0a;
            color: #a7a7a7;
            border: 1px solid #334155;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            🧙‍♂️ Gandalf System Health
            <button class="refresh-btn" onclick="checkAllHealth()">Refresh</button>
        </h1>

        <div class="health-grid" id="health-grid">
            <div class="health-card" id="collector-status">
                <h3>Data Collector</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>
            <div class="health-card" id="analyzer-status">
                <h3>Pattern Analyzer</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>
            <div class="health-card" id="monitor-status">
                <h3>System Monitor</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>
            <div class="health-card" id="database-status">
                <h3>Database</h3>
                <div class="status-icon">⏳</div>
                <div class="metric">Checking...</div>
            </div>
        </div>

        <h2>System Metrics</h2>
        <div class="health-grid" id="metrics-grid">
            <div class="health-card">
                <h3>Data Points (Total)</h3>
                <div class="metric" id="data-points">-</div>
            </div>
            <div class="health-card">
                <h3>Patterns Found (Total)</h3>
                <div class="metric" id="patterns-found">-</div>
            </div>
            <div class="health-card">
                <h3>Active Signals (Cache)</h3>
                <div class="metric" id="active-signals">-</div>
            </div>
            <div class="health-card">
                <h3>Last Collection</h3>
                <div class="metric" id="last-collection">-</div>
            </div>
        </div>

        <h2>Recent Logs (Simulated)</h2>
        <div class="logs" id="logs">
            <div>Loading logs...</div>
        </div>
    </div>

    <script>
        // NEW SECURE WAY: All requests go through our own API gateway
        const API_BASE_URL = '/api';

        async function checkHealth(service, url) {
            const card = document.getElementById(`${service}-status`);
            try {
                // For internal services, we can call them directly
                const externalUrl = `https://${service}.psnedujime.workers.dev`;
                const response = await fetch(externalUrl);
                const data = await response.json();

                if (response.ok && (data.status === 'healthy' || data.healthy)) {
                    card.className = 'health-card healthy';
                    card.querySelector('.status-icon').textContent = '✅';
                    card.querySelector('.metric').textContent = 'Operational';
                    if (service === 'collector' && data.last_collection_timestamp) {
                        const age = Math.round((Date.now() - new Date(data.last_collection_timestamp).getTime()) / 60000);
                        document.getElementById('last-collection').textContent = `${age} min ago`;
                    }
                } else {
                    card.className = 'health-card warning';
                    card.querySelector('.status-icon').textContent = '⚠️';
                    card.querySelector('.metric').textContent = data.issue || 'Issues Detected';
                }
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Offline';
            }
        }

        async function checkDatabaseHealth() {
            const card = document.getElementById('database-status');
            try {
                // UPDATED: Use the API Gateway for this request
                const response = await fetch(`${API_BASE_URL}/market_data?select=timestamp&order=timestamp.desc&limit=1`);
                if (response.ok) {
                    card.className = 'health-card healthy';
                    card.querySelector('.status-icon').textContent = '✅';
                    card.querySelector('.metric').textContent = 'Connected';
                } else {
                    throw new Error('Database error');
                }
            } catch (error) {
                card.className = 'health-card error';
                card.querySelector('.status-icon').textContent = '❌';
                card.querySelector('.metric').textContent = 'Connection Failed';
            }
        }

        async function loadMetrics() {
            try {
                // Total Data Points
                const dpResponse = await fetch(`${API_BASE_URL}/market_data?select=count`, { headers: { 'Range-Unit': 'items', 'Range': '0-1' } });
                const dpCount = dpResponse.headers.get('content-range').split('/')[1];
                document.getElementById('data-points').textContent = dpCount || '-';

                // Total Patterns
                const pResponse = await fetch(`${API_BASE_URL}/discovered_patterns?select=count`, { headers: { 'Range-Unit': 'items', 'Range': '0-1' } });
                const pCount = pResponse.headers.get('content-range').split('/')[1];
                document.getElementById('patterns-found').textContent = pCount || '-';

                // Active Signals from Analyzer Cache
                const sigResponse = await fetch(`${API_BASE_URL}/signals`);
                const signals = await sigResponse.json();
                document.getElementById('active-signals').textContent = signals.length;

            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        function loadLogs() {
            const logsDiv = document.getElementById('logs');
            const now = new Date();
            const logs = [
                `[${new Date(now.getTime() - 10000).toLocaleTimeString()}] System health check completed`,
                `[${new Date(now.getTime() - 4 * 60000).toLocaleTimeString()}] Data collection cycle finished`,
                `[${new Date(now.getTime() - 15 * 60000).toLocaleTimeString()}] Pattern analysis completed, 2 alerts sent.`,
                `[${new Date(now.getTime() - 31 * 60000).toLocaleTimeString()}] System monitor check passed.`
            ];
            logsDiv.innerHTML = logs.map(log => `<div>${log}</div>`).join('');
        }

        async function checkAllHealth() {
            // Check each service in parallel
            await Promise.all([
                checkHealth('gandalf-collector', 'https://gandalf-collector.psnedujime.workers.dev/health'),
                checkHealth('gandalf-analyzer', 'https://gandalf-analyzer.psnedujime.workers.dev'),
                checkHealth('gandalf-monitor', 'https://gandalf-monitor.psnedujime.workers.dev'),
                checkDatabaseHealth(),
                loadMetrics(),
                loadLogs()
            ]);
        }

        // Check on load and every 30 seconds
        checkAllHealth();
        setInterval(checkAllHealth, 30000);
    </script>
</body>
</html>