<!DOCTYPE html>
<html>
<head>
    <title>Gandalf Market Intelligence</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }

        .spread {
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧙‍♂️ Gandalf Market Intelligence</h1>
        <div id="status">Loading...</div>
        <div id="items" class="item-grid"></div>
    </div>
    <script src="config.js"></script>

    <script>
        const SUPABASE_URL = CONFIG.SUPABASE_URL;
        const SUPABASE_KEY = CONFIG.SUPABASE_KEY;

        async function loadData() {
            try {
                // Get latest data for each item
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/market_data?order=timestamp.desc&limit=50`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY
                        }
                    }
                );

                const data = await response.json();
                displayData(data);

            } catch (error) {
                document.getElementById('status').textContent = 'Error loading data';
                console.error(error);
            }
        }

        function displayData(data) {
            // Group by item, keep latest
            const latestByItem = {};
            data.forEach(row => {
                if (!latestByItem[row.item] ||
                    new Date(row.timestamp) > new Date(latestByItem[row.item].timestamp)) {
                    latestByItem[row.item] = row;
                }
            });

            const container = document.getElementById('items');
            container.innerHTML = '';

            Object.values(latestByItem).forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                        <h3>${item.item.replace(/_/g, ' ').toUpperCase()}</h3>
                        <div class="price">
                            Buy: ${item.buy_median || 'N/A'}p |
                            Sell: ${item.sell_median || 'N/A'}p
                        </div>
                        <div class="spread">
                            Spread: ${item.spread || 'N/A'}p
                        </div>
                        <div style="color: #666; font-size: 12px; margin-top: 10px;">
                            ${new Date(item.timestamp).toLocaleString()}
                        </div>
                    `;
                container.appendChild(card);
            });

            document.getElementById('status').textContent =
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        // Load on start and refresh every minute
        loadData();
        setInterval(loadData, 60000);
    </script>
</body>
</html>