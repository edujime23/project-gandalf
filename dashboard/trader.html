<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gandalf Trading Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151934;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border-color: #2a3356;
            --accent-primary: #6366f1;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
        }

        body {
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit,minmax(240px,1fr));
            gap: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            margin-top: 6px;
        }

        .trading-panel {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .position-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-pnl {
            font-weight: 700;
        }

        .profit {
            color: var(--accent-success);
        }

        .loss {
            color: var(--accent-danger);
        }

        .btn {
            background: var(--accent-primary);
            color: #fff;
            border: 0;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .btn-danger {
            background: var(--accent-danger);
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">Total PnL</div><div class="stat-value" id="total-pnl">+0p</div></div>
            <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value" id="win-rate">0%</div></div>
            <div class="stat-card"><div class="stat-label">Open Positions</div><div class="stat-value" id="open-positions">0</div></div>
            <div class="stat-card"><div class="stat-label">Sharpe Ratio</div><div class="stat-value" id="sharpe-ratio">0.00</div></div>
        </div>

        <div class="trading-panel">
            <div>
                <h3>Trading Signals</h3>
                <div id="active-signals"></div>
                <h3 style="margin-top:10px;">Open Positions</h3>
                <div id="open-positions-list"></div>
            </div>
            <div>
                <div class="card">
                    <h3>Quick Trade (disabled)</h3>
                    <p style="color:var(--text-secondary); font-size:13px;">Trade execution via UI is disabled on the public dashboard.</p>
                    <p style="color:var(--text-secondary); font-size:13px;">Signals and positions are read-only.</p>
                </div>
                <div class="card" style="margin-top:10px;">
                    <h3>Latest Backtest</h3>
                    <div id="backtest-metrics">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';

        async function fetchJSON(url, opts = {}) {
            const r = await fetch(url, opts);
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        }

        async function loadSignals() {
            try {
                const signals = await fetchJSON(`${API}/signals`);
                const el = document.getElementById('active-signals');
                el.innerHTML = (signals || []).slice(0, 8).map(s => {
                    const c = s.type === 'BUY' ? 'profit' : 'loss';
                    return `<div class="position-card">
            <div class="position-header">
              <div><strong>${s.item.replace(/_/g, ' ').toUpperCase()}</strong><div style="color:#8892b0;font-size:12px;">${s.reason || ''}</div></div>
              <div class="position-pnl ${c}">${s.type}</div>
            </div>
            <div style="color:#8892b0;font-size:12px;">Confidence: ${Math.round((s.confidence || 0) * 100)}%</div>
          </div>`;
                }).join('') || '<div class="card">No active signals</div>';
                document.getElementById('open-positions').textContent = '0';
            } catch (e) {
                document.getElementById('active-signals').innerHTML = '<div class="card">Error loading signals</div>';
            }
        }

        async function loadPositions() {
            try {
                const pos = await fetchJSON(`${API}/portfolio`);
                const el = document.getElementById('open-positions-list');
                if (!pos.length) { el.innerHTML = '<div class="card">No open positions</div>'; return; }
                el.innerHTML = pos.map(p => {
                    const pnl = (p.current_price - p.avg_buy_price) * p.quantity;
                    const c = pnl >= 0 ? 'profit' : 'loss';
                    return `<div class="position-card">
            <div class="position-header">
              <div><strong>${p.item.replace(/_/g, ' ').toUpperCase()}</strong><div style="color:#8892b0;font-size:12px;">${p.quantity} @ ${p.avg_buy_price}p</div></div>
              <div class="position-pnl ${c}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(0)}p</div>
            </div>
          </div>`;
                }).join('');
                document.getElementById('open-positions').textContent = pos.length;
            } catch (e) {
                document.getElementById('open-positions-list').innerHTML = '<div class="card">Error loading positions</div>';
            }
        }

        async function loadBacktest() {
            try {
                const res = await fetchJSON(`${API}/backtest_results?order=created_at.desc&limit=1`);
                const el = document.getElementById('backtest-metrics');
                if (!res.length) { el.textContent = 'No backtests found'; return; }
                const r = res[0];
                document.getElementById('sharpe-ratio').textContent = (r.sharpe_ratio || 0).toFixed(2);
                el.innerHTML = `
          <div>Strategy: <strong>${r.strategy_name}</strong></div>
          <div>Total Return: <strong style="color:${r.total_return >= 0 ? '#10b981' : '#ef4444'};">${r.total_return >= 0 ? '+' : ''}${r.total_return.toFixed(1)}%</strong></div>
          <div>Win Rate: <strong>${r.win_rate.toFixed(1)}%</strong></div>
          <div>Max Drawdown: <strong style="color:#ef4444;">${r.max_drawdown.toFixed(1)}%</strong></div>
          <div>Trades: <strong>${r.total_trades}</strong></div>
        `;
            } catch (e) {
                document.getElementById('backtest-metrics').textContent = 'Error loading backtest';
            }
        }

        async function loadMetrics() {
            try {
                const m = await fetchJSON(`${API}/rpc/get_enhanced_metrics`, { method: 'POST' });
                document.getElementById('total-pnl').textContent = (m.last_24h_profit >= 0 ? '+' : '') + (m.last_24h_profit || 0).toFixed(0) + 'p';
                document.getElementById('win-rate').textContent = (m.win_rate_7d || 0).toFixed(1) + '%';
            } catch (e) { }
        }

        (async function init() {
            await Promise.all([loadSignals(), loadPositions(), loadBacktest(), loadMetrics()]);
        })();
    </script>
</body>
</html>